{"version":3,"sources":["../../src/transaction/transaction-query.js"],"names":["makeTransactionQuery","database","Object","freeze","add","findById","findByCustomerId","getTransactions","remove","update","max","before","after","db","query","_id","$lt","makeId","$gt","collection","find","limit","Number","toArray","map","documentToTransaction","transactionId","transaction","result","ops","insertOne","catch","mongoError","errorCode","message","split","_","mongoIndex","UniqueConstraintError","success","ok","created","id","newSet","$set","surname","othernames","email","phone","customer_id","payment_id","amount","paid_month","paid_year","bank","account_id","account_name","account_type","status","date","updateOne","upsert","found","findOne","deleteMany","n","doc"],"mappings":"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","sourcesContent":["import makeTransaction from './transaction'\nimport { UniqueConstraintError } from '../helpers/errors'\n\nexport default function makeTransactionQuery({database}){\n    return Object.freeze({\n        add,\n        findById,\n        findByCustomerId,\n        getTransactions,\n        remove,\n        update\n    });\n\n    async function getTransactions ({ max = 100, before, after } = {}) {\n        const db = await database;\n        const query = {}\n        if (before || after) {\n        query._id = {}\n        query._id = before ? { ...query._id, $lt: db.makeId(before) } : query._id\n        query._id = after ? { ...query._id, $gt: db.makeId(after) } : query._id\n        }\n\n        return (await db\n        .collection('Transaction')\n        .find(query)\n        .limit(Number(max))\n        .toArray()).map(documentToTransaction)\n    }\n\n\n    async function add ({ transactionId, ...transaction }) {\n        const db = await database\n        if (transactionId) {\n          transaction._id = db.makeId(transactionId)\n        }\n        const { result, ops } = await db\n          .collection('Transaction')\n          .insertOne(transaction)\n          .catch(mongoError => {\n            const [errorCode] = mongoError.message.split(' ')\n            if (errorCode === 'E11000') {\n              const [_, mongoIndex] = mongoError.message.split(':')[2].split(' ')\n              throw new UniqueConstraintError(\n                \n              )\n            }\n            throw mongoError\n          })\n        return {\n            success: result.ok === 1,\n            created: documentToTransaction(ops[0])\n        }\n    }\n\n    async function update ({ id, ...transaction }) {\n      \n      const db = await database\n      const query = {\n        _id: db.makeId(id)\n      }\n      \n      const newSet = {\n        $set : {\n          surname: transaction.surname,\n          othernames: transaction.othernames,\n          email: transaction.email,\n          phone: transaction.phone,\n          customer_id: transaction.customer_id,\n          payment_id: transaction.payment_id,\n          amount: transaction.amount,\n          paid_month: transaction.paid_month,\n          paid_year: transaction.paid_year,\n          bank: transaction.bank,\n          account_id: transaction.account_id,\n          account_name: transaction.account_name,\n          account_type: transaction.account_type,\n          status: transaction.status,\n          date: transaction.date\n        } \n      }\n      /*if (id) {\n        _id = db.makeId(id)\n      }*/\n      const { result } = await db\n        .collection('Transaction')\n        .updateOne(query, newSet, {upsert:true})\n\n        if (result) {\n          return {\n            status: \"success\",\n            message: \"Updated successfully\"\n          }\n        }\n        else {\n          return {\n            status: \"error\",\n            message: \"Error updating\"\n          }\n        }\n      \n  }\n\n    \n  async function findById ({ transactionId }) {\n    const db = await database\n    const found = await db\n      .collection('Transaction')\n      .findOne({ _id: db.makeId(transactionId) })\n    if (found) {\n      return documentToTransaction(found)\n    }\n    return null\n  }\n\n  async function findByCustomerId ({ customer_id }) {\n    const db = await database;\n    \n    return (await db\n      .collection('Transaction')\n      .find({ customer_id: customer_id })\n      .toArray()).map(documentToTransaction)\n  }\n\n  async function remove ({ transactionId, ...transaction }) {\n    const db = await database\n    if (transactionId) {\n        transaction._id = db.makeId(transactionId)\n    }\n\n    const { result } = await db.collection('Transaction').deleteMany(transaction)\n    return result.n\n  }\n\n  function documentToTransaction ({ _id: id, ...doc }) {\n    return makeTransaction({ id, ...doc })\n  }\n}"],"file":"transaction-query.js"}