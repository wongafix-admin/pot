{"version":3,"sources":["../../src/deal/deal-query.js"],"names":["makeDealQuery","database","Object","freeze","add","findByCustomerId","findById","getDeals","deleteByCustomerId","deleteById","update","max","before","after","db","query","_id","$lt","makeId","$gt","collection","find","limit","Number","toArray","map","documentToDeal","dealId","deal","insertOne","then","result","console","log","insertedId","success","ok","id","catch","mongoError","errorCode","message","split","_","mongoIndex","UniqueConstraintError","deals","newSet","$set","surname","othernames","customer_id","phone","email","loan_amount","loan_duration","loan_monthly_payable","loan_due_date","last_month_paid","last_year_paid","office","office_phone","office_email","guarantor_name","guarantor_home_address","guarantor_office_address","guarantor_phone","guarantor_monthly_income","guarantor_collateral","salary_bank","num_account","upload_id_card","pay_status","status","date","updateOne","upsert","found","findOne","deleteMany","n","deleteOne","deletedCount","doc"],"mappings":"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","sourcesContent":["import makeDeal from './deal'\nimport { UniqueConstraintError } from '../helpers/errors'\n\nexport default function makeDealQuery({database}){\n    return Object.freeze({\n        add,\n        findByCustomerId,\n        findById,\n        getDeals,\n        deleteByCustomerId,\n        deleteById,\n        update\n    });\n\n    async function getDeals ({ max = 100, before, after } = {}) {\n        const db = await database;\n        const query = {}\n        if (before || after) {\n        query._id = {}\n        query._id = before ? { ...query._id, $lt: db.makeId(before) } : query._id\n        query._id = after ? { ...query._id, $gt: db.makeId(after) } : query._id\n        }\n\n        return (await db\n        .collection('Deal')\n        .find(query)\n        .limit(Number(max))\n        .toArray()).map(documentToDeal)\n    }\n\n\n    async function add ({ dealId, ...deal }) {\n        const db = await database\n        if (dealId) {\n          deal._id = db.makeId(dealId)\n        }\n\n        return db.collection(\"Deal\")\n          .insertOne(deal)\n          .then(result => {\n            console.log(result.insertedId);\n            return {\n              success: result.ok === 1,\n              id: result.insertedId\n              }\n        }).catch(mongoError => {\n          const [errorCode] = mongoError.message.split(' ')\n              if (errorCode === 'E11000') {\n                const [_, mongoIndex] = mongoError.message.split(':')[2].split(' ')\n                throw new UniqueConstraintError(\n                  mongoIndex === 'ContactEmailIndex' ? 'emailAddress' : 'contactId'\n                )\n              }\n              throw mongoError\n        });\n\n\n        // const { result, ops } = await db\n        //   .collection('Deal')\n        //   .insertOne(deal)\n        //   .catch(mongoError => {\n        //     const [errorCode] = mongoError.message.split(' ')\n        //     if (errorCode === 'E11000') {\n        //       const [_, mongoIndex] = mongoError.message.split(':')[2].split(' ')\n        //       throw new UniqueConstraintError(\n        //         mongoIndex === 'ContactEmailIndex' ? 'emailAddress' : 'contactId'\n        //       )\n        //     }\n        //     throw mongoError\n        //   })\n        // return {\n        //     success: result.insertedId,//result.ok === 1,\n        //     id: result.insertedId\n        // }\n    }\n\n    async function update ({ id, ...deals }) {\n        const db = await database\n        const query = {\n          _id: db.makeId(id)\n        }\n        \n        const newSet = {\n          $set : {\n\n            surname: deals.surname,\n            othernames: deals.othernames,\n            customer_id: deals.customer_id,\n            phone: deals.phone,\n            email: deals.email,\n            loan_amount: deals.loan_amount,\n            loan_duration: deals.loan_duration,\n            loan_monthly_payable: deals.loan_monthly_payable,\n            loan_due_date: deals.loan_due_date,\n            last_month_paid: deals.last_month_paid,\n            last_year_paid: deals.last_year_paid,\n\n            office: deals.office,\n            office_phone: deals.office_phone,\n            office_email: deals.office_email, \n            \n            guarantor_name: deals.guarantor_name,\n            guarantor_home_address: deals.guarantor_home_address,\n            guarantor_office_address: deals.guarantor_office_address,\n            guarantor_phone: deals.guarantor_phone,\n            guarantor_monthly_income: deals.guarantor_monthly_income,\n            guarantor_collateral: deals.guarantor_collateral,\n            \n            salary_bank: deals.salary_bank,\n            num_account: deals.num_account,\n\n            upload_id_card: deals.upload_id_card,\n\n            pay_status: deals.pay_status,\n            status: deals.status,\n            date: deals.date\n\n\n            \n          } \n        }\n        /*if (id) {\n          _id = db.makeId(id)\n        }*/\n        const { result } = await db\n          .collection('Deal')\n          .updateOne(query, newSet, {upsert:true})\n\n          if (result) {\n            return {\n              status: \"success\",\n              message: \"Updated successfully\"\n            }\n          }\n          else {\n            return {\n              status: \"error\",\n              message: \"Error updating\"\n            }\n          }\n        \n    }\n\n  async function findById ({ id }) {\n    const db = await database\n    const found = await db\n      .collection('Deal')\n      .findOne({ _id: db.makeId(id) })\n    if (found) {\n      return documentToDeal(found)\n    }\n    return null\n  }\n\n  async function findByCustomerId ({ customer_id }) {\n    const db = await database;\n    \n    return (await db\n      .collection('Deal')\n      .find({ customer_id: customer_id })\n      .toArray()).map(documentToDeal)\n  }\n\n  async function deleteByCustomerId ({ customer_id }) {\n    const db = await database\n\n    const { result } = await db.collection('Deal').deleteMany({\"customer_id\": customer_id})\n    return {\n      success: result.n\n    }\n  }\n\n  async function deleteById ({ id }) {\n    const db = await database\n\n    const { result } = await db.collection('Deal').deleteOne({\"_id\": db.makeId(id)})\n    console.log(result);\n    if (result.deletedCount > 0){\n      return {\n        status: \"Success\"\n      }\n    }\n    else {\n      return {\n        status: \"Error\"\n      }\n    }\n  }\n\n  function documentToDeal ({ _id: id, ...doc }) {\n    return makeDeal({ id, ...doc })\n  }\n}"],"file":"deal-query.js"}